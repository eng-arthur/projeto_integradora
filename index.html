<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Monitoramento em Tempo Real</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    .container {
      display: flex;
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: #020617;
      padding: 30px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      flex-shrink: 0;
    }
    .historico-container {
      flex: 1;
      background: #020617;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
    }
    .sensor {
      margin: 15px 0;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
    }
    .valor {
      font-weight: bold;
      color: #38bdf8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #334155;
    }
    th {
      background: #1e293b;
    }
    tr:hover {
      background: rgba(56, 189, 248, 0.1);
    }
    .data-hora {
      color: #94a3b8;
      font-size: 14px;
    }
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .card { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üìç Monitoramento</h1>
      <div id="infoPaciente" style="margin-bottom: 20px; padding: 10px; background: #1e293b; border-radius: 8px;">
        <div><strong>Paciente:</strong> <span id="nomePaciente">--</span></div>
        <div><strong>ID:</strong> <span id="idPaciente">--</span></div>
      </div>
      <div class="sensor">
        <span>‚ù§Ô∏è Frequ√™ncia Card√≠aca</span>
        <span class="valor" id="freq">-- bpm</span>
      </div>
      <div class="sensor">
        <span>ü©∏ Oximetria</span>
        <span class="valor" id="oxi">-- %</span>
      </div>
      <div class="sensor">
        <span>üå°Ô∏è Temperatura</span>
        <span class="valor" id="temp">-- ¬∞C</span>
      </div>
    </div>

    <div class="historico-container">
      <h1>üìä Hist√≥rico</h1>
      <table>
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Frequ√™ncia Card√≠aca</th>
            <th>Oximetria</th>
            <th>Temperatura</th>
          </tr>
        </thead>
        <tbody id="tabelaCorpo">
          <tr>
            <td colspan="4" style="text-align: center; padding: 40px;">
              Carregando...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    console.log("=== INICIANDO ===");
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDURF1Z7S-O0y1mfc0Sf8sjY9KGLJwkYHY",
      authDomain: "projeto-integradora-ii.firebaseapp.com",
      databaseURL: "https://projeto-integradora-ii-default-rtdb.firebaseio.com",
      projectId: "projeto-integradora-ii",
      storageBucket: "projeto-integradora-ii.firebasestorage.app",
      messagingSenderId: "80939508930",
      appId: "1:80939508930:web:9a2d2f9bf97be9eb98075b"
    };

    console.log("üì° Conectando...");

    try {
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      console.log("‚úÖ Conectado!");

      const freqElement = document.getElementById('freq');
      const oxiElement = document.getElementById('oxi');
      const tempElement = document.getElementById('temp');
      const nomePacienteElement = document.getElementById('nomePaciente');
      const idPacienteElement = document.getElementById('idPaciente');
      const tabelaCorpo = document.getElementById('tabelaCorpo');

      // CONECTAR DIRETAMENTE AOS SENSORES (est√£o na raiz!)
      const sensoresAtuaisRef = ref(db, "sensores_atuais");
      const historicoRef = ref(db, "sensores_historico");
      const pacienteRef = ref(db, "Paciente");

      console.log("üîç Buscando dados do paciente...");
      
      // 1. BUSCAR DADOS DO PACIENTE
      onValue(pacienteRef, (snapshot) => {
        const paciente = snapshot.val();
        console.log("üë§ Dados do paciente:", paciente);
        
        if (paciente) {
          nomePacienteElement.textContent = paciente.nome || "N√£o informado";
          idPacienteElement.textContent = paciente.id_paciente || "N√£o informado";
        }
      });

      // 2. BUSCAR DADOS EM TEMPO REAL
      console.log("üîç Buscando sensores atuais...");
      onValue(sensoresAtuaisRef, (snapshot) => {
        const sensores = snapshot.val();
        console.log("üîÑ Sensores atuais:", sensores);
        
        if (sensores) {
          // Frequ√™ncia card√≠aca
          if (sensores.freq_cardiaca !== undefined) {
            freqElement.textContent = sensores.freq_cardiaca + " bpm";
            freqElement.style.color = sensores.freq_cardiaca > 100 || sensores.freq_cardiaca < 60 ? '#ef4444' : '#38bdf8';
          }
          
          // Oximetria
          if (sensores.oximetria !== undefined) {
            oxiElement.textContent = sensores.oximetria + " %";
            oxiElement.style.color = sensores.oximetria < 95 ? '#ef4444' : '#38bdf8';
          }
          
          // Temperatura
          if (sensores.temperatura !== undefined) {
            tempElement.textContent = sensores.temperatura + " ¬∞C";
            tempElement.style.color = sensores.temperatura > 37.5 ? '#ef4444' : '#38bdf8';
          }
        } else {
          console.warn("‚ö†Ô∏è Sensores atuais vazios");
        }
      });

      // 3. BUSCAR HIST√ìRICO
      console.log("üîç Buscando hist√≥rico...");
      onValue(historicoRef, (snapshot) => {
        const historico = snapshot.val();
        console.log("üìö Hist√≥rico completo:", historico);
        
        if (!historico) {
          console.warn("‚ö†Ô∏è Hist√≥rico vazio");
          tabelaCorpo.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px;">
                Hist√≥rico vazio
              </td>
            </tr>
          `;
          return;
        }
        
        // Processar hist√≥rico
        mostrarHistorico(historico);
      });

      // FUN√á√ÉO PARA MOSTRAR HIST√ìRICO
      function mostrarHistorico(historico) {
        console.log("üìã Processando hist√≥rico...");
        
        // Limpar tabela
        tabelaCorpo.innerHTML = '';
        let totalRegistros = 0;
        
        // 1. FREQU√äNCIA CARD√çACA
        if (historico.freq_cardiaca) {
          console.log("‚ù§Ô∏è Hist√≥rico de frequ√™ncia:", historico.freq_cardiaca);
          
          Object.entries(historico.freq_cardiaca).forEach(([dataString, registrosData]) => {
            console.log(`   Data: ${dataString}`, registrosData);
            
            Object.entries(registrosData).forEach(([idRegistro, valor]) => {
              // Formatar data
              let dataFormatada = dataString;
              if (dataString.includes('_')) {
                const [dataPart, horaPart] = dataString.split('_');
                const [ano, mes, dia] = dataPart.split('-');
                const [hora, minuto, segundo] = horaPart.split('-');
                dataFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
              }
              
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="data-hora">${dataFormatada}</td>
                <td>${valor} bpm</td>
                <td>--</td>
                <td>--</td>
              `;
              tabelaCorpo.appendChild(tr);
              totalRegistros++;
            });
          });
        }
        
        // 2. OXIMETRIA
        if (historico.oximetria) {
          console.log("ü©∏ Hist√≥rico de oximetria:", historico.oximetria);
          
          Object.entries(historico.oximetria).forEach(([dataString, registrosData]) => {
            Object.entries(registrosData).forEach(([idRegistro, valor]) => {
              let dataFormatada = dataString;
              if (dataString.includes('_')) {
                const [dataPart, horaPart] = dataString.split('_');
                const [ano, mes, dia] = dataPart.split('-');
                const [hora, minuto, segundo] = horaPart.split('-');
                dataFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
              }
              
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="data-hora">${dataFormatada}</td>
                <td>--</td>
                <td>${valor} %</td>
                <td>--</td>
              `;
              tabelaCorpo.appendChild(tr);
              totalRegistros++;
            });
          });
        }
        
        // 3. TEMPERATURA
        if (historico.temperatura) {
          console.log("üå°Ô∏è Hist√≥rico de temperatura:", historico.temperatura);
          
          Object.entries(historico.temperatura).forEach(([dataString, registrosData]) => {
            Object.entries(registrosData).forEach(([idRegistro, valor]) => {
              let dataFormatada = dataString;
              if (dataString.includes('_')) {
                const [dataPart, horaPart] = dataString.split('_');
                const [ano, mes, dia] = dataPart.split('-');
                const [hora, minuto, segundo] = horaPart.split('-');
                dataFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
              }
              
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="data-hora">${dataFormatada}</td>
                <td>--</td>
                <td>--</td>
                <td>${valor} ¬∞C</td>
              `;
              tabelaCorpo.appendChild(tr);
              totalRegistros++;
            });
          });
        }
        
        console.log(`‚úÖ Total de registros: ${totalRegistros}`);
        
        if (totalRegistros === 0) {
          tabelaCorpo.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px;">
                Nenhum registro hist√≥rico encontrado
              </td>
            </tr>
          `;
        }
      }

      console.log("‚úÖ Tudo configurado!");

    } catch (error) {
      console.error("‚ùå ERRO:", error);
      document.body.innerHTML = `
        <div style="text-align: center; padding: 100px; color: #ef4444;">
          <h1>ERRO</h1>
          <p>${error.message}</p>
        </div>
      `;
    }
  </script>
</body>
</html>