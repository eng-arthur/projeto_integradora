<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Monitoramento em Tempo Real</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    .container {
      display: flex;
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: #020617;
      padding: 30px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      flex-shrink: 0;
      height: fit-content;
    }
    .historico-container {
      flex: 1;
      background: #020617;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      min-height: 500px;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
    }
    .sensor {
      margin: 15px 0;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
    }
    .valor {
      font-weight: bold;
      color: #38bdf8;
    }
    .controles {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    select, button {
      padding: 10px 15px;
      background: #1e293b;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    button {
      background: #38bdf8;
    }
    button:hover {
      background: #0ea5e9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #334155;
    }
    th {
      background: #1e293b;
    }
    tr:hover {
      background: rgba(56, 189, 248, 0.1);
    }
    .data-hora {
      color: #94a3b8;
      font-size: 14px;
    }
    .status {
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
    }
    .online {
      background: #10b981;
      color: white;
    }
    .offline {
      background: #ef4444;
      color: white;
    }
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .card { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Card dos sensores em tempo real -->
    <div class="card">
      <h1>üìç Monitoramento em Tempo Real</h1>
      <div class="sensor">
        <span>‚ù§Ô∏è Frequ√™ncia Card√≠aca</span>
        <span class="valor" id="freq">-- bpm</span>
      </div>
      <div class="sensor">
        <span>ü©∏ Oximetria</span>
        <span class="valor" id="oxi">-- %</span>
      </div>
      <div class="sensor">
        <span>üå°Ô∏è Temperatura</span>
        <span class="valor" id="temp">-- ¬∞C</span>
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <span class="status online" id="status">ONLINE</span>
      </div>
    </div>

    <!-- Se√ß√£o de hist√≥rico -->
    <div class="historico-container">
      <h1>üìä Hist√≥rico do Paciente</h1>
      <div class="controles">
        <select id="selectSensor">
          <option value="todos">Todos os sensores</option>
          <option value="freq_cardiaca">Frequ√™ncia Card√≠aca</option>
          <option value="oximetria">Oximetria</option>
          <option value="temperatura">Temperatura</option>
        </select>
        <button id="btnAtualizar">‚Üª Atualizar Hist√≥rico</button>
      </div>
      
      <div id="historicoTabela">
        <table>
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Frequ√™ncia Card√≠aca</th>
              <th>Oximetria</th>
              <th>Temperatura</th>
            </tr>
          </thead>
          <tbody id="tabelaCorpo">
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px;">
                Conectando ao banco de dados...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SCRIPT JS DIRETO NO HTML (EVITA PROBLEMAS DE CARREGAMENTO) -->
  <script type="module">
    // Importa o Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // CONFIGURA√á√ÉO DO FIREBASE - SUAS CREDENCIAIS
    const firebaseConfig = {
      apiKey: "AIzaSyDURF1Z7S-O0y1mfc0Sf8sjY9KGLJwkYHY",
      authDomain: "projeto-integradora-ii.firebaseapp.com",
      databaseURL: "https://projeto-integradora-ii-default-rtdb.firebaseio.com",
      projectId: "projeto-integradora-ii",
      storageBucket: "projeto-integradora-ii.firebasestorage.app",
      messagingSenderId: "80939508930",
      appId: "1:80939508930:web:9a2d2f9bf97be9eb98075b"
    };

    console.log("üöÄ Iniciando conex√£o com Firebase...");

    try {
      // Inicializa Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      console.log("‚úÖ Firebase conectado!");

      // Elementos da p√°gina
      const freqElement = document.getElementById('freq');
      const oxiElement = document.getElementById('oxi');
      const tempElement = document.getElementById('temp');
      const statusElement = document.getElementById('status');
      const tabelaCorpo = document.getElementById('tabelaCorpo');
      const btnAtualizar = document.getElementById('btnAtualizar');
      const selectSensor = document.getElementById('selectSensor');

      // Vari√°veis
      let pacienteNome = null;
      let dadosHistorico = null;
      let ultimaAtualizacao = new Date();

      // 1. BUSCAR DADOS DO FIREBASE
      function buscarDadosFirebase() {
        console.log("üì° Buscando dados do Firebase...");
        
        const rootRef = ref(db);
        
        onValue(rootRef, (snapshot) => {
          const dadosCompletos = snapshot.val();
          console.log("üì¶ Dados recebidos:", dadosCompletos);
          
          if (!dadosCompletos) {
            console.error("‚ùå Banco de dados vazio!");
            mostrarErro("Banco de dados vazio");
            return;
          }
          
          // Encontrar o nome do paciente (primeira chave)
          const chaves = Object.keys(dadosCompletos);
          pacienteNome = chaves[0];
          console.log("‚úÖ Paciente encontrado:", pacienteNome);
          
          // Atualizar tempo real
          atualizarTempoReal(dadosCompletos[pacienteNome]);
          
          // Atualizar hist√≥rico
          atualizarHistorico(dadosCompletos[pacienteNome]);
          
          // Atualizar status
          ultimaAtualizacao = new Date();
          statusElement.textContent = `ONLINE - ${ultimaAtualizacao.toLocaleTimeString('pt-BR')}`;
          statusElement.className = "status online";
          
        }, (error) => {
          console.error("‚ùå Erro ao conectar:", error);
          mostrarErro("Erro de conex√£o");
          statusElement.textContent = "OFFLINE";
          statusElement.className = "status offline";
        });
      }

      // 2. ATUALIZAR DADOS EM TEMPO REAL
      function atualizarTempoReal(dadosPaciente) {
        if (!dadosPaciente || !dadosPaciente.sensores_atuais) {
          console.warn("‚ö†Ô∏è Dados em tempo real n√£o dispon√≠veis");
          return;
        }
        
        const sensores = dadosPaciente.sensores_atuais;
        console.log("üîÑ Dados tempo real:", sensores);
        
        // Frequ√™ncia card√≠aca
        if (sensores.freq_cardiaca !== undefined) {
          freqElement.textContent = `${sensores.freq_cardiaca} bpm`;
          freqElement.style.color = sensores.freq_cardiaca > 100 || sensores.freq_cardiaca < 60 ? '#ef4444' : '#38bdf8';
        }
        
        // Oximetria
        if (sensores.oximetria !== undefined) {
          oxiElement.textContent = `${sensores.oximetria} %`;
          oxiElement.style.color = sensores.oximetria < 95 ? '#ef4444' : '#38bdf8';
        }
        
        // Temperatura
        if (sensores.temperatura !== undefined) {
          tempElement.textContent = `${sensores.temperatura} ¬∞C`;
          tempElement.style.color = sensores.temperatura > 37.5 ? '#ef4444' : '#38bdf8';
        }
      }

      // 3. ATUALIZAR HIST√ìRICO
      function atualizarHistorico(dadosPaciente) {
        if (!dadosPaciente || !dadosPaciente.sensores_historico) {
          console.warn("‚ö†Ô∏è Hist√≥rico n√£o dispon√≠vel");
          tabelaCorpo.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px;">
                Hist√≥rico n√£o dispon√≠vel
              </td>
            </tr>
          `;
          return;
        }
        
        dadosHistorico = dadosPaciente.sensores_historico;
        console.log("üìö Dados hist√≥ricos recebidos:", dadosHistorico);
        
        // Processar hist√≥rico
        processarEExibirHistorico();
      }

      // 4. PROCESSAR E EXIBIR HIST√ìRICO
      function processarEExibirHistorico() {
        const sensorSelecionado = selectSensor.value;
        let todosRegistros = [];
        
        // PROCESSAR FREQU√äNCIA CARD√çACA
        if (dadosHistorico.freq_cardiaca && (sensorSelecionado === 'todos' || sensorSelecionado === 'freq_cardiaca')) {
          processarSensor('freq_cardiaca', 'bpm', dadosHistorico.freq_cardiaca, todosRegistros);
        }
        
        // PROCESSAR OXIMETRIA
        if (dadosHistorico.oximetria && (sensorSelecionado === 'todos' || sensorSelecionado === 'oximetria')) {
          processarSensor('oximetria', '%', dadosHistorico.oximetria, todosRegistros);
        }
        
        // PROCESSAR TEMPERATURA
        if (dadosHistorico.temperatura && (sensorSelecionado === 'todos' || sensorSelecionado === 'temperatura')) {
          processarSensor('temperatura', '¬∞C', dadosHistorico.temperatura, todosRegistros);
        }
        
        console.log(`üìä Total de registros: ${todosRegistros.length}`);
        
        // Ordenar por data (mais recente primeiro)
        todosRegistros.sort((a, b) => b.dataCompleta.localeCompare(a.dataCompleta));
        
        // Exibir na tabela
        exibirNaTabela(todosRegistros);
      }

      // 5. PROCESSAR UM SENSOR ESPEC√çFICO
      function processarSensor(tipo, unidade, dadosSensor, arrayRegistros) {
        // Para cada data (ex: "1969-12-31_21-00-03")
        Object.entries(dadosSensor).forEach(([dataString, registrosData]) => {
          // Para cada registro dentro da data
          Object.entries(registrosData).forEach(([idRegistro, valor]) => {
            arrayRegistros.push({
              dataString: dataString,
              dataFormatada: formatarData(dataString),
              dataCompleta: dataString, // Para ordena√ß√£o
              tipo: tipo,
              valor: valor,
              unidade: unidade,
              id: idRegistro
            });
          });
        });
      }

      // 6. EXIBIR DADOS NA TABELA
      function exibirNaTabela(registros) {
        tabelaCorpo.innerHTML = '';
        
        if (registros.length === 0) {
          tabelaCorpo.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px;">
                Nenhum registro encontrado
              </td>
            </tr>
          `;
          return;
        }
        
        // Limitar a 50 registros para performance
        const registrosExibir = registros.slice(0, 50);
        
        registrosExibir.forEach((registro, index) => {
          const tr = document.createElement('tr');
          
          // Determinar quais colunas preencher
          let freq = '--';
          let oxi = '--';
          let temp = '--';
          
          if (registro.tipo === 'freq_cardiaca') {
            freq = `${registro.valor} ${registro.unidade}`;
          } else if (registro.tipo === 'oximetria') {
            oxi = `${registro.valor} ${registro.unidade}`;
          } else if (registro.tipo === 'temperatura') {
            temp = `${registro.valor} ${registro.unidade}`;
          }
          
          tr.innerHTML = `
            <td class="data-hora">${registro.dataFormatada}</td>
            <td>${freq}</td>
            <td>${oxi}</td>
            <td>${temp}</td>
          `;
          
          tabelaCorpo.appendChild(tr);
        });
        
        // Adicionar contador
        if (registros.length > 50) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td colspan="4" style="text-align: center; padding: 10px; color: #94a3b8; font-size: 12px;">
              Mostrando 50 de ${registros.length} registros
            </td>
          `;
          tabelaCorpo.appendChild(tr);
        }
      }

      // 7. FUN√á√ïES AUXILIARES
      function formatarData(dataString) {
        // Formatar "1969-12-31_21-00-03" para "31/12/1969 21:00:03"
        if (dataString && dataString.includes('_')) {
          try {
            const [dataPart, horaPart] = dataString.split('_');
            const [ano, mes, dia] = dataPart.split('-');
            const [hora, minuto, segundo] = horaPart.split('-');
            return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
          } catch (e) {
            return dataString;
          }
        }
        return dataString || 'Data desconhecida';
      }

      function mostrarErro(mensagem) {
        tabelaCorpo.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 40px; color: #ef4444;">
              ‚ùå ${mensagem}
            </td>
          </tr>
        `;
        
        freqElement.textContent = '-- bpm';
        oxiElement.textContent = '-- %';
        tempElement.textContent = '-- ¬∞C';
      }

      // 8. EVENT LISTENERS
      btnAtualizar.addEventListener('click', () => {
        console.log("üîÑ Atualiza√ß√£o manual solicitada");
        buscarDadosFirebase();
      });

      selectSensor.addEventListener('change', () => {
        if (dadosHistorico) {
          console.log("üîç Aplicando filtro:", selectSensor.value);
          processarEExibirHistorico();
        }
      });

      // 9. INICIAR TUDO
      buscarDadosFirebase();

      // Atualizar automaticamente a cada 30 segundos
      setInterval(() => {
        console.log("‚è∞ Atualiza√ß√£o autom√°tica");
        buscarDadosFirebase();
      }, 30000);

    } catch (error) {
      console.error("‚ùå Erro cr√≠tico:", error);
      document.body.innerHTML = `
        <div style="text-align: center; padding: 50px; color: #ef4444;">
          <h1>‚ùå Erro ao carregar aplica√ß√£o</h1>
          <p>${error.message}</p>
          <p>Verifique o console para mais detalhes (F12)</p>
        </div>
      `;
    }
  </script>
</body>
</html>