<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Monitoramento em Tempo Real</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    .container {
      display: flex;
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: #020617;
      padding: 30px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      flex-shrink: 0;
    }
    .historico-container {
      flex: 1;
      background: #020617;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
    }
    .sensor {
      margin: 15px 0;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
    }
    .valor {
      font-weight: bold;
      color: #38bdf8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #334155;
    }
    th {
      background: #1e293b;
    }
    tr:hover {
      background: rgba(56, 189, 248, 0.1);
    }
    .data-hora {
      color: #94a3b8;
      font-size: 14px;
    }
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .card { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üìç Sensores em Tempo Real</h1>
      <div class="sensor">
        <span>‚ù§Ô∏è Frequ√™ncia Card√≠aca</span>
        <span class="valor" id="freq">-- bpm</span>
      </div>
      <div class="sensor">
        <span>ü©∏ Oximetria</span>
        <span class="valor" id="oxi">-- %</span>
      </div>
      <div class="sensor">
        <span>üå°Ô∏è Temperatura</span>
        <span class="valor" id="temp">-- ¬∞C</span>
      </div>
    </div>

    <div class="historico-container">
      <h1>üìä Hist√≥rico do Paciente</h1>
      <table>
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Frequ√™ncia Card√≠aca</th>
            <th>Oximetria</th>
            <th>Temperatura</th>
          </tr>
        </thead>
        <tbody id="tabelaCorpo">
          <tr>
            <td colspan="4" style="text-align: center; padding: 40px;">
              Aguardando dados...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    console.log("=== INICIANDO SCRIPT ===");
    
    // PASSO 1: Importar Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // PASSO 2: Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDURF1Z7S-O0y1mfc0Sf8sjY9KGLJwkYHY",
      authDomain: "projeto-integradora-ii.firebaseapp.com",
      databaseURL: "https://projeto-integradora-ii-default-rtdb.firebaseio.com",
      projectId: "projeto-integradora-ii",
      storageBucket: "projeto-integradora-ii.firebasestorage.app",
      messagingSenderId: "80939508930",
      appId: "1:80939508930:web:9a2d2f9bf97be9eb98075b"
    };

    console.log("üì° Conectando ao Firebase...");

    try {
      // PASSO 3: Inicializar Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      console.log("‚úÖ Firebase conectado!");

      // PASSO 4: Pegar elementos da p√°gina
      const freqElement = document.getElementById('freq');
      const oxiElement = document.getElementById('oxi');
      const tempElement = document.getElementById('temp');
      const tabelaCorpo = document.getElementById('tabelaCorpo');

      // PASSO 5: Conectar √† raiz do banco
      const rootRef = ref(database);
      
      console.log("üîç Ouvindo por dados na raiz...");
      
      onValue(rootRef, (snapshot) => {
        const todosDados = snapshot.val();
        console.log("üì¶ DADOS RECEBIDOS:", todosDados);
        
        if (!todosDados) {
          console.error("‚ùå Banco de dados VAZIO!");
          tabelaCorpo.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px; color: #ef4444;">
                ‚ùå Banco de dados vazio!
              </td>
            </tr>
          `;
          return;
        }
        
        // PASSO 6: Encontrar o nome do paciente
        const nomesPacientes = Object.keys(todosDados);
        console.log("üë§ Pacientes encontrados:", nomesPacientes);
        
        if (nomesPacientes.length === 0) {
          console.error("‚ùå Nenhum paciente encontrado!");
          return;
        }
        
        const nomePrimeiroPaciente = nomesPacientes[0];
        console.log("üéØ Usando paciente:", nomePrimeiroPaciente);
        
        const dadosPaciente = todosDados[nomePrimeiroPaciente];
        console.log("üìä Dados do paciente:", dadosPaciente);
        
        // PASSO 7: Atualizar dados em tempo real
        if (dadosPaciente.sensores_atuais) {
          const sensores = dadosPaciente.sensores_atuais;
          console.log("üîÑ Dados tempo real:", sensores);
          
          // Frequ√™ncia card√≠aca
          if (sensores.freq_cardiaca !== undefined) {
            freqElement.textContent = sensores.freq_cardiaca + " bpm";
            console.log("‚ù§Ô∏è Frequ√™ncia:", sensores.freq_cardiaca);
          }
          
          // Oximetria
          if (sensores.oximetria !== undefined) {
            oxiElement.textContent = sensores.oximetria + " %";
            console.log("ü©∏ Oximetria:", sensores.oximetria);
          }
          
          // Temperatura
          if (sensores.temperatura !== undefined) {
            tempElement.textContent = sensores.temperatura + " ¬∞C";
            console.log("üå°Ô∏è Temperatura:", sensores.temperatura);
          }
        }
        
        // PASSO 8: Mostrar hist√≥rico
        if (dadosPaciente.sensores_historico) {
          console.log("üìö Hist√≥rico dispon√≠vel!");
          mostrarHistorico(dadosPaciente.sensores_historico);
        } else {
          console.warn("‚ö†Ô∏è Nenhum hist√≥rico encontrado");
          tabelaCorpo.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px;">
                Nenhum hist√≥rico dispon√≠vel
              </td>
            </tr>
          `;
        }
        
      }, (error) => {
        console.error("‚ùå ERRO ao ler dados:", error);
        tabelaCorpo.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 40px; color: #ef4444;">
              ‚ùå Erro ao conectar: ${error.message}
            </td>
          </tr>
        `;
      });

      // FUN√á√ÉO PARA MOSTRAR HIST√ìRICO
      function mostrarHistorico(historico) {
        console.log("üìã Processando hist√≥rico:", historico);
        
        // Limpar tabela
        tabelaCorpo.innerHTML = '';
        
        // Verificar se tem dados de frequ√™ncia card√≠aca
        if (historico.freq_cardiaca) {
          console.log("‚ù§Ô∏è Hist√≥rico de frequ√™ncia:", historico.freq_cardiaca);
          
          // Para cada data (ex: "1969-12-31_21-00-03")
          Object.entries(historico.freq_cardiaca).forEach(([dataString, registrosData]) => {
            console.log(`üìÖ Data: ${dataString}`, registrosData);
            
            // Para cada registro dentro da data
            Object.entries(registrosData).forEach(([idRegistro, valor]) => {
              console.log(`   ID: ${idRegistro}, Valor: ${valor}`);
              
              // Formatar a data
              let dataFormatada = dataString;
              if (dataString.includes('_')) {
                const [dataPart, horaPart] = dataString.split('_');
                const [ano, mes, dia] = dataPart.split('-');
                const [hora, minuto, segundo] = horaPart.split('-');
                dataFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
              }
              
              // Criar linha na tabela
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="data-hora">${dataFormatada}</td>
                <td>${valor} bpm</td>
                <td>--</td>
                <td>--</td>
              `;
              tabelaCorpo.appendChild(tr);
            });
          });
        }
        
        // Verificar oximetria
        if (historico.oximetria) {
          console.log("ü©∏ Hist√≥rico de oximetria:", historico.oximetria);
          
          Object.entries(historico.oximetria).forEach(([dataString, registrosData]) => {
            Object.entries(registrosData).forEach(([idRegistro, valor]) => {
              let dataFormatada = dataString;
              if (dataString.includes('_')) {
                const [dataPart, horaPart] = dataString.split('_');
                const [ano, mes, dia] = dataPart.split('-');
                const [hora, minuto, segundo] = horaPart.split('-');
                dataFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
              }
              
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="data-hora">${dataFormatada}</td>
                <td>--</td>
                <td>${valor} %</td>
                <td>--</td>
              `;
              tabelaCorpo.appendChild(tr);
            });
          });
        }
        
        // Verificar temperatura
        if (historico.temperatura) {
          console.log("üå°Ô∏è Hist√≥rico de temperatura:", historico.temperatura);
          
          Object.entries(historico.temperatura).forEach(([dataString, registrosData]) => {
            Object.entries(registrosData).forEach(([idRegistro, valor]) => {
              let dataFormatada = dataString;
              if (dataString.includes('_')) {
                const [dataPart, horaPart] = dataString.split('_');
                const [ano, mes, dia] = dataPart.split('-');
                const [hora, minuto, segundo] = horaPart.split('-');
                dataFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
              }
              
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="data-hora">${dataFormatada}</td>
                <td>--</td>
                <td>--</td>
                <td>${valor} ¬∞C</td>
              `;
              tabelaCorpo.appendChild(tr);
            });
          });
        }
        
        // Se n√£o adicionou nenhum registro
        if (tabelaCorpo.children.length === 0) {
          console.warn("‚ö†Ô∏è Nenhum registro hist√≥rico processado");
          tabelaCorpo.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px;">
                Hist√≥rico vazio
              </td>
            </tr>
          `;
        } else {
          console.log(`‚úÖ ${tabelaCorpo.children.length} registros exibidos`);
        }
      }

    } catch (error) {
      console.error("‚ùå ERRO CR√çTICO:", error);
      document.body.innerHTML = `
        <div style="text-align: center; padding: 100px; color: #ef4444;">
          <h1>ERRO CR√çTICO</h1>
          <p>${error.message}</p>
          <p>Verifique o console (F12) para detalhes</p>
        </div>
      `;
    }
    
    console.log("=== FIM DO SCRIPT ===");
  </script>
</body>
</html>